%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Second stage ini_file for DSM
%
% May, 2022 Sara Knox
% Jan, 2023 Adatpted for BB by June Skeeter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Site_name = 'Burns Bog'
SiteID = 'BB'
input_path    = ''
output_path   = 'C:/Users/User/PostDoc_Work/Database_local/yyyy/BB/clean/SecondStage/' 
high_level_path = {}
searchPath = 'low_level,current'

% 20230111: Modified for June Skeeter local database

% Contents:
% Misc. variables
% Profiles
% Radiation
% Soil
% Turbulent fluxes
% Carbon balance terms
% Energy storage terms

% ----------------------------------------------------------------------------
% Misc. important variables - temperature, pressure etc.
% ----------------------------------------------------------------------------

[Trace]
	variableName = 'TA_1_1_1'

	Evaluate = 'TA_1_1_1 = calc_avg_trace(clean_tv,TA_1_1_1,TA_ECCC,-1);
				% Remove spikes
				wlen=24; % data points used in each window (unit: 30min)
				thres=4; % ratio of std for lower and upper bound
				
				TA_1_1_1 = run_std_dev(TA_1_1_1,clean_tv,wlen,thres);'
	% is timeshift correction necessary?
	% is spike removal necessary

	title = 'Air temperature at 2m (HMP)'
	units = '^oC'
	minMax = [-20,50]
[End]

[Trace]
	variableName = 'TA_1_2_1'

	Evaluate = 'TA_1_2_1 = calc_avg_trace(clean_tv,TA_1_2_1,TA_ECCC,-1);'
	% Should we be filling temps at 35 cm with temps at ECCC from 2m?

	title = 'Air temperature at 30cm (HMP)'
	units = '^oC'
	minMax = [-20,50]
[End]

[Trace]
	variableName = 'RH_1_1_1'

	Evaluate = 'RH_1_1_1 = calc_avg_trace(clean_tv,RH_1_1_1,RH_ECCC,-1);'
	% is this necessary: RH_ECCC(ind_delete) = NaN?

	title = 'RH at 2m (HMP)'
	units = '%'
	minMax = [0,110]
	clamped_minMax = [0,100] 
[End]

[Trace]
	variableName = 'RH_1_2_1'

	Evaluate = 'RH_1_2_1 = calc_avg_trace(clean_tv,RH_1_2_1,RH_ECCC,-1);'
	% Should we be filling RH at 35 cm with RH at ECCC from 2m?

	
	title = 'RH at 35cm (HMP)'
	units = '%'
	minMax = [0,110]
	clamped_minMax = [0,100] 
[End]

[Trace]
	variableName = 'VPD_1_1_1'

	Evaluate = '[e_H,ea_H] = vappress(TA_1_1_1,RH_1_1_1);
				VPD_1_1_1 = ea_H - e_H;
				VPD_1_1_1 = VPD_1_1_1*10;' % Converting kPa to hPa

	title = 'Vapour pressure deficit Vapour pressure deficit (from 2m HMP)'
	units = 'hPa'
	minMax = [0,100]
[End]


[Trace]
	variableName = 'TS_1_1_1'

	Evaluate = 'TS_1_1_1 = calc_avg_trace(clean_tv,[TS_1_1_1]);'

	title = 'average soil temperature at 5cm depth'
	units = '^oC'
	minMax = [-20,60]
[End]

[Trace]
	variableName = 'TS_1_2_1'

	Evaluate = 'TS_1_2_1 = calc_avg_trace(clean_tv,[TS_1_2_1]);'

	title = 'average soil temperature at 10cm depth'
	units = '^oC'
	minMax = [-20,60]
[End]

[Trace]
	variableName = 'TS_1_3_1'

	Evaluate = 'TS_1_3_1 = calc_avg_trace(clean_tv,[TS_1_3_1])'

	title = 'average soil temperature at 50cm depth'
	units = '^oC'
	minMax = [-20,60]
[End]


[Trace]
	variableName = 'G_1'

	Evaluate = 'p=find(clean_tv<=datenum(2021,09,09,12,30,0));
				mins =[nanmin(G_1_1_1), nanmin(G_2_1_1),  nanmin(G_3_1_1)];
				maxs =[nanmax(G_1_1_1), nanmax(G_2_1_1),  nanmax(G_3_1_1)];
				slps =[ 40.9846,  39.0569,  29.2824]; 
				ofts =[-16.8590, -16.1501, -11.2575];

				G_1_1_1(p)=slps(1)*((G_1_1_1(p)-mins(1))./(maxs(1)-mins(1)))+ofts(1);
				G_2_1_1(p)=slps(2)*((G_2_1_1(p)-mins(2))./(maxs(2)-mins(2)))+ofts(2);
				G_3_1_1(p)=slps(3)*((G_3_1_1(p)-mins(3))./(maxs(3)-mins(3)))+ofts(3);

				G_1 = calc_avg_trace(clean_tv,[G_1_1_1, G_2_1_1, G_3_1_1]);'

	title = 'soil heat flux at 5cm depth'
	units = 'âˆžC'
	minMax = [-40,60]
[End]
